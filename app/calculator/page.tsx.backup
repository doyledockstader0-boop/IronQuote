'use client';

import { useState, useMemo } from 'react';

// ============================================================================
// TYPES & INTERFACES
// ============================================================================

interface CustomerInfo {
  firstName: string;
  lastName: string;
  businessName: string;
  address: string;
  email: string;
  phone: string;
}

interface StandardArea {
  id: string;
  areaName: string;
  length: number;
  width: number;
  floorType: string;
  soilLevel: 'Light' | 'Medium' | 'Heavy' | '';
  runRate: number;
}

interface SUTMInfo {
  totalFixtures: number;
  minutesPerFixture: number;
}

interface FrequencyRate {
  frequency: number;
  hourlyRate: number;
}

interface SpecialService {
  id: string;
  name: string;
  price: number;
  checked: boolean;
}

// ============================================================================
// CONSTANTS
// ============================================================================

const BUILDING_TYPES = [
  'Office',
  'Medical',
  'Retail',
  'Industrial',
  'School',
  'Church',
  'Restaurant',
  'Other'
];

const FLOOR_TYPES = [
  'Carpet',
  'Tile',
  'VCT',
  'Concrete',
  'Hardwood',
  'Laminate',
  'Other'
];

const SOIL_LEVELS = ['Light', 'Medium', 'Heavy'];

const RUN_RATE_OPTIONS = [
  1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000, 5500, 6000
];

const FREQUENCY_OPTIONS = [1, 2, 3, 4, 5, 6, 7];

const HOURLY_RATE_OPTIONS = Array.from({ length: 31 }, (_, i) => 20 + i);

const MINUTES_PER_FIXTURE_OPTIONS = [2.5, 3, 3.5, 4, 4.5, 5];

const MONTHLY_MINIMUMS: { [key: number]: number } = {
  1: 275,
  2: 390,
  3: 585,
  4: 780,
  5: 975,
};

const SURCHARGE_FREQUENCIES = [6, 7];
const SURCHARGE_MULTIPLIER = 1.2;

// ============================================================================
// MAIN COMPONENT
// ============================================================================

export default function QuoteCalculator() {
  // ============================================================================
  // STATE
  // ============================================================================
  
  const [currentStep, setCurrentStep] = useState(1);
  const [darkMode, setDarkMode] = useState(false);
  
  // Step 1: Customer Information
  const [customerInfo, setCustomerInfo] = useState<CustomerInfo>({
    firstName: '',
    lastName: '',
    businessName: '',
    address: '',
    email: '',
    phone: '',
  });
  
  // Step 2: Standard Areas
  const [buildingType, setBuildingType] = useState('');
  const [standardAreas, setStandardAreas] = useState<StandardArea[]>([
    {
      id: '1',
      areaName: '',
      length: 0,
      width: 0,
      floorType: '',
      soilLevel: '',
      runRate: 0,
    },
  ]);
  
  // Step 3: SUTM Areas
  const [sutmInfo, setSutmInfo] = useState<SUTMInfo>({
    totalFixtures: 0,
    minutesPerFixture: 0,
  });
  
  // Step 4: Frequency & Rate
  const [frequencyRate, setFrequencyRate] = useState<FrequencyRate>({
    frequency: 0,
    hourlyRate: 0,
  });
  
  // Step 5: Special Services
  const [specialServices, setSpecialServices] = useState<SpecialService[]>([
    { id: '1', name: '', price: 0, checked: false },
  ]);

  // ============================================================================
  // CALCULATIONS
  // ============================================================================
  
  const calculations = useMemo(() => {
    // Standard Areas Calculation
    const standardTotal = standardAreas.reduce((total, area) => {
      if (!area.length || !area.width || !area.runRate) return total;
      const sqft = area.length * area.width;
      const monthlyHours = (sqft / area.runRate) * frequencyRate.frequency * 4.33;
      const monthlyCost = monthlyHours * frequencyRate.hourlyRate;
      return total + monthlyCost;
    }, 0);
    
    // SUTM Calculation
    const sutmTotal = sutmInfo.totalFixtures && sutmInfo.minutesPerFixture && frequencyRate.frequency && frequencyRate.hourlyRate
      ? (sutmInfo.totalFixtures * sutmInfo.minutesPerFixture / 60) * frequencyRate.frequency * 4.33 * frequencyRate.hourlyRate
      : 0;
    
    // Subtotal before minimums and surcharges
    let subtotal = standardTotal + sutmTotal;
    
    // Apply monthly minimum
    const monthlyMinimum = MONTHLY_MINIMUMS[frequencyRate.frequency] || 0;
    if (subtotal > 0 && subtotal < monthlyMinimum) {
      subtotal = monthlyMinimum;
    }
    
    // Apply 6x/7x surcharge
    if (SURCHARGE_FREQUENCIES.includes(frequencyRate.frequency) && subtotal > 0) {
      subtotal = subtotal * SURCHARGE_MULTIPLIER;
    }
    
    // Special Services
    const specialTotal = specialServices
      .filter(s => s.checked && s.price > 0)
      .reduce((sum, s) => sum + s.price, 0);
    
    const grandTotal = subtotal + specialTotal;
    
    return {
      standardTotal,
      sutmTotal,
      subtotal,
      specialTotal,
      grandTotal,
      monthlyMinimum,
      surchargeApplied: SURCHARGE_FREQUENCIES.includes(frequencyRate.frequency) && subtotal > 0,
    };
  }, [standardAreas, sutmInfo, frequencyRate, specialServices]);

  // ============================================================================
  // HANDLERS
  // ============================================================================
  
  const addStandardArea = () => {
    setStandardAreas([
      ...standardAreas,
      {
        id: Date.now().toString(),
        areaName: '',
        length: 0,
        width: 0,
        floorType: '',
        soilLevel: '',
        runRate: 0,
      },
    ]);
  };
  
  const removeStandardArea = (id: string) => {
    if (standardAreas.length > 1) {
      setStandardAreas(standardAreas.filter(area => area.id !== id));
    }
  };
  
  const updateStandardArea = (id: string, field: keyof StandardArea, value: any) => {
    setStandardAreas(
      standardAreas.map(area =>
        area.id === id ? { ...area, [field]: value } : area
      )
    );
  };
  
  const addSpecialService = () => {
    setSpecialServices([
      ...specialServices,
      {
        id: Date.now().toString(),
        name: '',
        price: 0,
        checked: false,
      },
    ]);
  };
  
  const removeSpecialService = (id: string) => {
    if (specialServices.length > 1) {
      setSpecialServices(specialServices.filter(s => s.id !== id));
    }
  };
  
  const updateSpecialService = (id: string, field: keyof SpecialService, value: any) => {
    setSpecialServices(
      specialServices.map(s =>
        s.id === id ? { ...s, [field]: value } : s
      )
    );
  };

  // ============================================================================
  // THEME CLASSES
  // ============================================================================
  
  const theme = {
    bg: darkMode ? 'bg-gray-900' : 'bg-gray-50',
    card: darkMode ? 'bg-gray-800' : 'bg-white',
    text: darkMode ? 'text-gray-100' : 'text-gray-900',
    textMuted: darkMode ? 'text-gray-400' : 'text-gray-600',
    border: darkMode ? 'border-gray-700' : 'border-gray-200',
    input: darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-white border-gray-300 text-gray-900',
    button: darkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600',
    buttonSecondary: darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300',
  };

  // ============================================================================
  // RENDER HELPERS
  // ============================================================================
  
  const renderProgressIndicator = () => {
    const steps = [
      { num: 1, label: 'Customer Info' },
      { num: 2, label: 'Standard Areas' },
      { num: 3, label: 'SUTM Areas' },
      { num: 4, label: 'Frequency & Rate' },
      { num: 5, label: 'Review & Generate' },
    ];
    
    return (
      <div className="flex items-center justify-between mb-8">
        {steps.map((step, index) => (
          <div key={step.num} className="flex items-center flex-1">
            <div className="flex flex-col items-center flex-1">
              <div
                className={`w-10 h-10 rounded-full flex items-center justify-center font-semibold ${
                  currentStep === step.num
                    ? 'bg-blue-500 text-white'
                    : currentStep > step.num
                    ? 'bg-green-500 text-white'
                    : darkMode
                    ? 'bg-gray-700 text-gray-400'
                    : 'bg-gray-200 text-gray-500'
                }`}
              >
                {currentStep > step.num ? '‚úì' : step.num}
              </div>
              <span className={`text-xs mt-2 ${theme.textMuted}`}>{step.label}</span>
            </div>
            {index < steps.length - 1 && (
              <div
                className={`h-1 flex-1 mx-2 ${
                  currentStep > step.num
                    ? 'bg-green-500'
                    : darkMode
                    ? 'bg-gray-700'
                    : 'bg-gray-200'
                }`}
              />
            )}
          </div>
        ))}
      </div>
    );
  };

  const renderStep1 = () => (
    <div className="space-y-6">
      <h2 className={`text-2xl font-bold ${theme.text}`}>Customer Information</h2>
      
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
            First Name *
          </label>
          <input
            type="text"
            value={customerInfo.firstName}
            onChange={(e) => setCustomerInfo({ ...customerInfo, firstName: e.target.value })}
            className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
            placeholder="John"
          />
        </div>
        
        <div>
          <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
            Last Name *
          </label>
          <input
            type="text"
            value={customerInfo.lastName}
            onChange={(e) => setCustomerInfo({ ...customerInfo, lastName: e.target.value })}
            className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
            placeholder="Doe"
          />
        </div>
      </div>
      
      <div>
        <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
          Business Name *
        </label>
        <input
          type="text"
          value={customerInfo.businessName}
          onChange={(e) => setCustomerInfo({ ...customerInfo, businessName: e.target.value })}
          className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
          placeholder="Acme Corporation"
        />
      </div>
      
      <div>
        <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
          Address *
        </label>
        <input
          type="text"
          value={customerInfo.address}
          onChange={(e) => setCustomerInfo({ ...customerInfo, address: e.target.value })}
          className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
          placeholder="123 Main St, City, State 12345"
        />
      </div>
      
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
            Email *
          </label>
          <input
            type="email"
            value={customerInfo.email}
            onChange={(e) => setCustomerInfo({ ...customerInfo, email: e.target.value })}
            className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
            placeholder="john@acme.com"
          />
        </div>
        
        <div>
          <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
            Phone *
          </label>
          <input
            type="tel"
            value={customerInfo.phone}
            onChange={(e) => setCustomerInfo({ ...customerInfo, phone: e.target.value })}
            className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
            placeholder="(555) 123-4567"
          />
        </div>
      </div>
    </div>
  );

  const renderStep2 = () => (
    <div className="space-y-6">
      <h2 className={`text-2xl font-bold ${theme.text}`}>Standard Areas</h2>
      
      <div>
        <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
          Building Type
        </label>
        <select
          value={buildingType}
          onChange={(e) => setBuildingType(e.target.value)}
          className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
        >
          <option value="">Select building type</option>
          {BUILDING_TYPES.map(type => (
            <option key={type} value={type}>{type}</option>
          ))}
        </select>
      </div>
      
      <div className="space-y-4">
        {standardAreas.map((area, index) => (
          <div key={area.id} className={`p-4 border rounded-lg ${theme.border} ${theme.card}`}>
            <div className="flex justify-between items-center mb-4">
              <h3 className={`font-semibold ${theme.text}`}>Area {index + 1}</h3>
              {standardAreas.length > 1 && (
                <button
                  onClick={() => removeStandardArea(area.id)}
                  className="text-red-500 hover:text-red-700"
                >
                  Remove
                </button>
              )}
            </div>
            
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2">
                <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
                  Area Name
                </label>
                <input
                  type="text"
                  value={area.areaName}
                  onChange={(e) => updateStandardArea(area.id, 'areaName', e.target.value)}
                  className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
                  placeholder="e.g., Main Office"
                />
              </div>
              
              <div>
                <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
                  Length (ft)
                </label>
                <input
                  type="number"
                  value={area.length || ''}
                  onChange={(e) => updateStandardArea(area.id, 'length', parseFloat(e.target.value) || 0)}
                  className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
                  placeholder="0"
                />
              </div>
              
              <div>
                <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
                  Width (ft)
                </label>
                <input
                  type="number"
                  value={area.width || ''}
                  onChange={(e) => updateStandardArea(area.id, 'width', parseFloat(e.target.value) || 0)}
                  className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
                  placeholder="0"
                />
              </div>
              
              <div>
                <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
                  Floor Type
                </label>
                <select
                  value={area.floorType}
                  onChange={(e) => updateStandardArea(area.id, 'floorType', e.target.value)}
                  className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
                >
                  <option value="">Select type</option>
                  {FLOOR_TYPES.map(type => (
                    <option key={type} value={type}>{type}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
                  Soil Level
                </label>
                <select
                  value={area.soilLevel}
                  onChange={(e) => updateStandardArea(area.id, 'soilLevel', e.target.value)}
                  className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
                >
                  <option value="">Select level</option>
                  {SOIL_LEVELS.map(level => (
                    <option key={level} value={level}>{level}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
                  Run Rate (sq ft/hr)
                </label>
                <select
                  value={area.runRate || ''}
                  onChange={(e) => updateStandardArea(area.id, 'runRate', parseFloat(e.target.value) || 0)}
                  className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
                >
                  <option value="">Select rate</option>
                  {RUN_RATE_OPTIONS.map(rate => (
                    <option key={rate} value={rate}>{rate}</option>
                  ))}
                </select>
              </div>
              
              <div className="col-span-2">
                <div className={`text-sm ${theme.textMuted}`}>
                  Square Footage: {area.length && area.width ? (area.length * area.width).toFixed(0) : 0} sq ft
                </div>
              </div>
            </div>
          </div>
        ))}
        
        <button
          onClick={addStandardArea}
          className={`w-full py-2 border-2 border-dashed rounded-lg ${theme.border} ${theme.textMuted} hover:${theme.border} transition-colors`}
        >
          + Add Another Area
        </button>
      </div>
    </div>
  );

  const renderStep3 = () => (
    <div className="space-y-6">
      <h2 className={`text-2xl font-bold ${theme.text}`}>SUTM Areas (Restrooms)</h2>
      
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
            Total Number of Fixtures
          </label>
          <input
            type="number"
            value={sutmInfo.totalFixtures || ''}
            onChange={(e) => setSutmInfo({ ...sutmInfo, totalFixtures: parseFloat(e.target.value) || 0 })}
            className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
            placeholder="0"
          />
          <p className={`text-xs mt-1 ${theme.textMuted}`}>
            Total count of sinks, toilets, urinals, and mirrors
          </p>
        </div>
        
        <div>
          <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
            Minutes per Fixture
          </label>
          <select
            value={sutmInfo.minutesPerFixture || ''}
            onChange={(e) => setSutmInfo({ ...sutmInfo, minutesPerFixture: parseFloat(e.target.value) || 0 })}
            className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
          >
            <option value="">Select minutes</option>
            {MINUTES_PER_FIXTURE_OPTIONS.map(minutes => (
              <option key={minutes} value={minutes}>{minutes} min</option>
            ))}
          </select>
        </div>
      </div>
      
      {sutmInfo.totalFixtures > 0 && sutmInfo.minutesPerFixture > 0 && (
        <div className={`p-4 rounded-lg ${darkMode ? 'bg-blue-900/20' : 'bg-blue-50'} ${theme.border}`}>
          <p className={`text-sm ${theme.text}`}>
            Total SUTM Time: {(sutmInfo.totalFixtures * sutmInfo.minutesPerFixture).toFixed(1)} minutes
            ({((sutmInfo.totalFixtures * sutmInfo.minutesPerFixture) / 60).toFixed(2)} hours)
          </p>
        </div>
      )}
    </div>
  );

  const renderStep4 = () => (
    <div className="space-y-6">
      <h2 className={`text-2xl font-bold ${theme.text}`}>Frequency & Hourly Rate</h2>
      
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
            Cleaning Frequency (times per week)
          </label>
          <select
            value={frequencyRate.frequency || ''}
            onChange={(e) => setFrequencyRate({ ...frequencyRate, frequency: parseInt(e.target.value) || 0 })}
            className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
          >
            <option value="">Select frequency</option>
            {FREQUENCY_OPTIONS.map(freq => (
              <option key={freq} value={freq}>{freq}x per week</option>
            ))}
          </select>
          {frequencyRate.frequency > 0 && MONTHLY_MINIMUMS[frequencyRate.frequency] && (
            <p className={`text-xs mt-1 ${theme.textMuted}`}>
              Monthly minimum: ${MONTHLY_MINIMUMS[frequencyRate.frequency]}
            </p>
          )}
        </div>
        
        <div>
          <label className={`block text-sm font-medium mb-2 ${theme.text}`}>
            Hourly Rate
          </label>
          <select
            value={frequencyRate.hourlyRate || ''}
            onChange={(e) => setFrequencyRate({ ...frequencyRate, hourlyRate: parseFloat(e.target.value) || 0 })}
            className={`w-full px-4 py-2 border rounded-lg ${theme.input}`}
          >
            <option value="">Select rate</option>
            {HOURLY_RATE_OPTIONS.map(rate => (
              <option key={rate} value={rate}>${rate}/hr</option>
            ))}
          </select>
        </div>
      </div>
    </div>
  );

  const renderStep5 = () => (
    <div className="space-y-6">
      <h2 className={`text-2xl font-bold ${theme.text}`}>Review & Generate Quote</h2>
      
      {/* Customer Info Summary */}
      <div className={`p-4 rounded-lg ${theme.card} border ${theme.border}`}>
        <h3 className={`font-semibold mb-3 ${theme.text}`}>Customer Information</h3>
        <div className="grid grid-cols-2 gap-3 text-sm">
          <div>
            <span className={theme.textMuted}>Name:</span>{' '}
            <span className={theme.text}>{customerInfo.firstName} {customerInfo.lastName}</span>
          </div>
          <div>
            <span className={theme.textMuted}>Business:</span>{' '}
            <span className={theme.text}>{customerInfo.businessName}</span>
          </div>
          <div className="col-span-2">
            <span className={theme.textMuted}>Address:</span>{' '}
            <span className={theme.text}>{customerInfo.address}</span>
          </div>
          <div>
            <span className={theme.textMuted}>Email:</span>{' '}
            <span className={theme.text}>{customerInfo.email}</span>
          </div>
          <div>
            <span className={theme.textMuted}>Phone:</span>{' '}
            <span className={theme.text}>{customerInfo.phone}</span>
          </div>
        </div>
      </div>
      
      {/* Standard Areas Breakdown */}
      <div className={`p-4 rounded-lg ${theme.card} border ${theme.border}`}>
        <h3 className={`font-semibold mb-3 ${theme.text}`}>Standard Areas</h3>
        {buildingType && (
          <p className={`text-sm mb-3 ${theme.textMuted}`}>Building Type: {buildingType}</p>
        )}
        <div className="space-y-2">
          {standardAreas.map((area, index) => {
            if (!area.length || !area.width || !area.runRate) return null;
            const sqft = area.length * area.width;
            const monthlyHours = (sqft / area.runRate) * frequencyRate.frequency * 4.33;
            const monthlyCost = monthlyHours * frequencyRate.hourlyRate;
            
            return (
              <div key={area.id} className={`text-sm p-3 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                <div className="flex justify-between mb-1">
                  <span className={theme.text}>{area.areaName || `Area ${index + 1}`}</span>
                  <span className={`font-semibold ${theme.text}`}>${monthlyCost.toFixed(2)}</span>
                </div>
                <div className={`text-xs ${theme.textMuted}`}>
                  {sqft} sq ft √ó {area.floorType} √ó {area.soilLevel} soil √ó {area.runRate} run rate
                </div>
              </div>
            );
          })}
        </div>
      </div>
      
      {/* SUTM Breakdown */}
      {sutmInfo.totalFixtures > 0 && sutmInfo.minutesPerFixture > 0 && (
        <div className={`p-4 rounded-lg ${theme.card} border ${theme.border}`}>
          <h3 className={`font-semibold mb-3 ${theme.text}`}>SUTM Areas</h3>
          <div className={`text-sm p-3 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
            <div className="flex justify-between mb-1">
              <span className={theme.text}>Restroom Fixtures</span>
              <span className={`font-semibold ${theme.text}`}>${calculations.sutmTotal.toFixed(2)}</span>
            </div>
            <div className={`text-xs ${theme.textMuted}`}>
              {sutmInfo.totalFixtures} fixtures √ó {sutmInfo.minutesPerFixture} min/fixture
            </div>
          </div>
        </div>
      )}
      
      {/* Special Services */}
      <div className={`p-4 rounded-lg ${theme.card} border ${theme.border}`}>
        <h3 className={`font-semibold mb-3 ${theme.text}`}>Special Services (Optional)</h3>
        <div className="space-y-3">
          {specialServices.map((service, index) => (
            <div key={service.id} className="flex gap-3">
              <input
                type="checkbox"
                checked={service.checked}
                onChange={(e) => updateSpecialService(service.id, 'checked', e.target.checked)}
                className="mt-1"
              />
              <div className="flex-1 grid grid-cols-2 gap-3">
                <input
                  type="text"
                  value={service.name}
                  onChange={(e) => updateSpecialService(service.id, 'name', e.target.value)}
                  placeholder="Service name"
                  className={`px-3 py-2 border rounded-lg text-sm ${theme.input}`}
                />
                <input
                  type="number"
                  value={service.price || ''}
                  onChange={(e) => updateSpecialService(service.id, 'price', parseFloat(e.target.value) || 0)}
                  placeholder="Price"
                  className={`px-3 py-2 border rounded-lg text-sm ${theme.input}`}
                />
              </div>
              {specialServices.length > 1 && (
                <button
                  onClick={() => removeSpecialService(service.id)}
                  className="text-red-500 hover:text-red-700"
                >
                  √ó
                </button>
              )}
            </div>
          ))}
          <button
            onClick={addSpecialService}
            className={`text-sm ${theme.textMuted} hover:${theme.text}`}
          >
            + Add Special Service
          </button>
        </div>
      </div>
      
      {/* Action Buttons */}
      <div className="flex gap-3">
        <button className={`flex-1 py-3 rounded-lg ${theme.button} text-white font-semibold`}>
          üìÑ Print Quote
        </button>
        <button className={`flex-1 py-3 rounded-lg ${theme.button} text-white font-semibold`}>
          üìß Email Quote
        </button>
        <button className={`flex-1 py-3 rounded-lg ${theme.button} text-white font-semibold`}>
          üöÄ Push to Operations
        </button>
      </div>
    </div>
  );

  // ============================================================================
  // MAIN RENDER
  // ============================================================================

  return (
    <div className={`min-h-screen ${theme.bg} transition-colors`}>
      {/* Header */}
      <div className={`${theme.card} border-b ${theme.border} sticky top-0 z-10 shadow-sm`}>
        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className={`w-10 h-10 rounded-lg ${
              darkMode ? 'bg-gray-700' : 'bg-gray-800'
            } flex items-center justify-center`}>
              <span className="text-white font-bold text-sm">IQ</span>
            </div>
            <h1 className={`text-2xl font-bold ${theme.text}`}>IronQuote</h1>
            <span className={`px-3 py-1 rounded-full text-xs font-medium ${
              darkMode 
                ? 'bg-gray-700 text-gray-300' 
                : 'bg-gray-200 text-gray-700'
            }`}>
              Tasket Demo Shell ‚Ä¢ v0.81
            </span>
          </div>
          <button
            onClick={() => setDarkMode(!darkMode)}
            className={`p-2 rounded-lg ${theme.buttonSecondary}`}
          >
            {darkMode ? '‚òÄÔ∏è' : 'üåô'}
          </button>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-6 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Main Form */}
          <div className="lg:col-span-2">
            <div className={`${theme.card} rounded-lg shadow-lg p-6 border ${theme.border}`}>
              {renderProgressIndicator()}
              
              {currentStep === 1 && renderStep1()}
              {currentStep === 2 && renderStep2()}
              {currentStep === 3 && renderStep3()}
              {currentStep === 4 && renderStep4()}
              {currentStep === 5 && renderStep5()}
              
              {/* Navigation Buttons */}
              <div className="flex justify-between mt-8 pt-6 border-t border-gray-200">
                <button
                  onClick={() => setCurrentStep(Math.max(1, currentStep - 1))}
                  disabled={currentStep === 1}
                  className={`px-6 py-2 rounded-lg ${theme.buttonSecondary} ${theme.text} font-semibold disabled:opacity-50 disabled:cursor-not-allowed`}
                >
                  Previous
                </button>
                <button
                  onClick={() => setCurrentStep(Math.min(5, currentStep + 1))}
                  disabled={currentStep === 5}
                  className={`px-6 py-2 rounded-lg ${theme.button} text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed`}
                >
                  {currentStep === 5 ? 'Complete' : 'Next'}
                </button>
              </div>
            </div>
          </div>

          {/* Pricing Sidebar */}
          <div className="lg:col-span-1">
            <div className={`${theme.card} rounded-lg shadow-lg p-6 border ${theme.border} sticky top-24`}>
              <h3 className={`text-xl font-bold mb-4 ${theme.text}`}>Quote Summary</h3>
              
              <div className="space-y-3">
                <div className="flex justify-between text-sm">
                  <span className={theme.textMuted}>Standard Areas:</span>
                  <span className={theme.text}>${calculations.standardTotal.toFixed(2)}</span>
                </div>
                
                <div className="flex justify-between text-sm">
                  <span className={theme.textMuted}>SUTM Areas:</span>
                  <span className={theme.text}>${calculations.sutmTotal.toFixed(2)}</span>
                </div>
                
                {calculations.monthlyMinimum > 0 && calculations.subtotal < calculations.monthlyMinimum && (
                  <div className={`flex justify-between text-sm ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                    <span>Monthly Minimum:</span>
                    <span>${calculations.monthlyMinimum.toFixed(2)}</span>
                  </div>
                )}
                
                {calculations.surchargeApplied && (
                  <div className={`flex justify-between text-sm ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                    <span>6x/7x Surcharge (20%):</span>
                    <span>Applied</span>
                  </div>
                )}
                
                <div className="flex justify-between text-sm">
                  <span className={theme.textMuted}>Special Services:</span>
                  <span className={theme.text}>${calculations.specialTotal.toFixed(2)}</span>
                </div>
                
                <div className={`border-t pt-3 ${theme.border}`}>
                  <div className="flex justify-between">
                    <span className={`text-lg font-bold ${theme.text}`}>Monthly Total:</span>
                    <span className="text-lg font-bold text-green-500">
                      ${calculations.grandTotal.toFixed(2)}
                    </span>
                  </div>
                </div>
                
                {frequencyRate.frequency > 0 && (
                  <div className={`text-xs text-center ${theme.textMuted} pt-2`}>
                    {frequencyRate.frequency}x per week @ ${frequencyRate.hourlyRate}/hr
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}